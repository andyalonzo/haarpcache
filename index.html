<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Haarpcache by andyalonzo</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Haarpcache</h1>
        <h2>Fork of thundercache, haarpcache one smart cache.</h2>
        <a href="https://github.com/andyalonzo/haarpcache" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="haarpcache" class="anchor" href="#haarpcache" aria-hidden="true"><span class="octicon octicon-link"></span></a>HaarpCache</h1>

<h2>
<a id="maintainer" class="anchor" href="#maintainer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Maintainer</h2>

<ul>
<li>
<a href="https://perufw.wordpress.com">Kei Kurono</a> &lt;<a href="mailto:kei.haarpcache@gmail.com">kei.haarpcache@gmail.com</a>&gt;</li>
</ul>

<h2>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of contents</h2>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#installing">Installing</a></li>
<li><a href="#reinstall-or-update">Reinstall or Update</a></li>
<li><a href="#monitoring-logs">Monitoring Logs</a></li>
<li><a href="#list-of-plugins">List of Plugins</a></li>
<li><a href="#changelog">Changelog</a></li>
</ul>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>Proxy HaarpCache is a fork of ThunderCache.</p>

<p>HaarpCache is a robust static and dynamic cache that provides support to the DASH technology.</p>

<h2>
<a id="installing" class="anchor" href="#installing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing</h2>

<pre><code>su
apt-get update 
apt-get upgrade
apt-get install build-essential mysql-server mysql-client php5 apache2 php5-mysql \
libblkid-dev libcurl4-gnutls-dev libmysqlclient15-dev libapache2-mod-auth-mysql \
libapache2-mod-php5 sharutils curl autoconf squid3 git g++-4.4
cd /usr/src/
git clone https://github.com/keikurono/haarpcache.git
cd haarpcache
./configure
./configure CXX=g++-4.4 # &lt;--- for ubuntu
make
make install
mysql -u root -p &lt; haarp.sql
cd /etc/init.d
update-rc.d haarp defaults 98
</code></pre>

<ul>
<li>
<p>Create a user for database of haarpcache:</p>

<pre><code>mysql -u root -p
grant all privileges on haarp.* to haarp_user@localhost identified by 'haarpcache_password';
</code></pre>

<p>Change the username ('haarp_user') and password ('haarpcache_password') for which you want.</p>
</li>
<li>
<p>Configure your /etc/haarp/haarp.conf</p>

<pre><code>CACHEDIR &lt;dir_1&gt;|&lt;dir_2&gt;|&lt;dir_3&gt; ...    
MYSQL_USER &lt;haarp_user&gt;
MYSQL_PASS &lt;haarpcache_password&gt;
</code></pre>

<p><code>&lt;dir_1&gt;</code>, <code>&lt;dir_2&gt;</code>,... are the directories where cache files will be stored, for default '/haarp/'.
<code>&lt;haarp_user&gt;</code> and <code>&lt;haarpcache_password&gt;</code> are the user and password for the database of haarpcache defined above.</p>
</li>
<li>
<p>Copy and paste the line above at the end of the file 'squid.conf' (or 'squid3.conf' which is in operation):</p>

<pre><code>acl haarp_lst url_regex -i "/etc/haarp/haarp.lst"
never_direct allow haarp_lst
cache deny haarp_lst
cache_peer 127.0.0.1 parent 8080 0 proxy-only no-digest
dead_peer_timeout 2 seconds
cache_peer_access 127.0.0.1 allow haarp_lst
cache_peer_access 127.0.0.1 deny all
</code></pre>
</li>
<li>
<p>Below the line of the <code>http_port</code> configuration, add: </p>

<pre><code>acl google url_regex -i (googlevideo.com|www.youtube.com)
acl iphone browser -i regexp (iPhone|iPad)
acl BB browser -i regexp (BlackBerry|PlayBook)
acl Winphone browser -i regexp (Windows.*Phone|Trident|IEMobile)
acl Android browser -i regexp Android
request_header_access User-Agent deny google !iphone !BB !Winphone !Android
request_header_replace User-Agent Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)
</code></pre>

<p>with this we avoid the redirects <code>HTTP</code> to <code>HTTPS</code> in <code>youtube.com</code>. Only works for PC's, and when you enter to <code>http://www.youtube.com</code> from the address bar (of your browser) or from <code>www.google.com</code>.</p>
</li>
<li>
<p>On squid.conf Comment the line:</p>

<pre><code>#hierarchy_stoplist cgi-bin ?
</code></pre>
</li>
<li>
<p>On crontab add the line:</p>

<pre><code>0 */1     * * *   root    /etc/init.d/haarpclean
</code></pre>
</li>
<li>
<p>View reports of your cache system:</p>

<pre><code>cp /usr/src/haarpcache/etc/haarp/haarp.php /var/www/
</code></pre>

<p>Change the line 24 of the file haarp.php with your user and password for your database haarpcache.</p>

<pre><code> if (!( $db = new PDO('mysql:host=localhost;dbname=haarp', 'haarp_user','haarpcache_password') ) )
</code></pre>
</li>
<li>
<p>Your viewer:</p>

<pre><code>http://&lt;IP_Your_Server&gt;/haarp.php
</code></pre>
</li>
<li>
<p>Security:</p>

<pre><code>iptables -I INPUT 1 -i &lt;eth_wan_1&gt; -m tcp -p tcp --dport 8080 -m state --state NEW -j DROP
iptables -I INPUT 1 -i &lt;eth_wan_2&gt; -m tcp -p tcp --dport 8080 -m state --state NEW -j DROP
...
</code></pre>

<p>The port 8080 is of your haarpcache server. You can change this editing the file /etc/haarp/haarp.conf. </p>
</li>
<li>
<p>Avoid the <code>QUIC</code> protocol connections on <code>www.youtube.com</code></p>

<pre><code>iptables -A FORWARD -i &lt;eth_lan&gt; -p udp -m udp --dport 80 -j REJECT --reject-with icmp-port-unreachable
iptables -A FORWARD -i &lt;eth_lan&gt; -p udp -m udp --dport 443 -j REJECT --reject-with icmp-port-unreachable
</code></pre>

<p>add the following line in <code>squid.conf</code>:</p>

<pre><code># Disable alternate protocols
reply_header_access Alternate-Protocol deny all
</code></pre>
</li>
<li><p>All iptables rules should be placed in a *.sh file to be executed whenever the computer is started.</p></li>
<li>
<p>Finally:</p>

<pre><code>/etc/init.d/haarp restart
squid -k reconfigure
</code></pre>
</li>
<li>
<p>Handling QoS can be done by making a marking of packages based on the search for the string "X-Cache: HIT from HAARP" or "HAARP: HIT from" in the packet header. Thus a possible handling may carried out as follows:</p>

<pre><code>IF_LAN=eth0
MAX_DOWN=1300kbps
MIN_CACHE_DOWN=1000kbps
MAX_CACHE_DOWN=1100kbps

iptables -A OUTPUT -t mangle -o $IF_LAN -p tcp -m string --string "X-Cache: HIT from Haarp" --algo kmp -j MARK --set-mark 666

tc qdisc add dev $IF_LAN root handle 1:0 htb default 10 r2q 15
tc class add dev $IF_LAN parent 1:0 classid 1:1 htb rate $MAX_DOWN ceil $MAX_DOWN
tc class add dev $IF_LAN parent 1:1 classid 1:66 htb rate $MIN_CACHE_DOWN ceil $MAX_CACHE_DOWN
tc qdisc add dev $IF_LAN parent 1:66 handle 66:0 sfq perturb 30
tc filter add dev $IF_LAN protocol ip parent 1:0 handle 666 fw classid 1:66
</code></pre>
</li>
</ul>

<h2>
<a id="reinstall-or-update" class="anchor" href="#reinstall-or-update" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reinstall or Update</h2>

<p>For a common update:</p>

<pre><code>    su
    cd /usr/src/
    rm -fr haarpcache 2&gt;/dev/null
    killall haarpclean 2&gt;/dev/null
    git clone https://github.com/keikurono/haarpcache.git
    cd haarpcache
    ./configure
    make
    make install
    mysql -u root -p &lt; haarp.sql
    cp -b etc/haarp/haarp.lst /etc/haarp/haarp.lst
    /etc/init.d/haarp restart
    squid -k reconfigure
</code></pre>

<h2>
<a id="monitoring-logs" class="anchor" href="#monitoring-logs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Monitoring Logs</h2>

<p>Depending on the location of the logs defined in the file <code>/etc/haarp/haarp.conf</code>:</p>

<pre><code>    tail -f /var/log/haarp/access.log
    tail -f /var/log/haarp/error.log
</code></pre>

<p>Level information in the logs: change the <code>LOGLEVEL</code> on <code>/etc/haarp/haarp.conf</code>.</p>

<h2>
<a id="list-of-plugins" class="anchor" href="#list-of-plugins" aria-hidden="true"><span class="octicon octicon-link"></span></a>List of Plugins</h2>

<ul>
<li>
<p>Currently Haarp supports:</p>

<p>Youtube (https not supported),
Netflix (Video and Images),
DoubleClick (Block of ADS),
Googlevideo,
Dailymotion,
AOL,
Vimeo,
Metacafe,
Modovideo,
Bitgravity,
Globo,
Terra,
Viddler,
Justin,
Edgecastcdn,
Youku,
Wrzuta,
5min,
Viddler,
Tumblr,
Facebook (https not supported);</p>

<p>Bomusica,
Bullafina,
Coqui,
Cutmu,
Domusica,
Domusicas,
Dungeonbusters,
Goobeo,
Gooveo,
Miniclip,
Molenillo,
Mp3-Buscador,
Musicaveo,
Ning,
Nofeehost,
Sonicomusica,
Turner,
Vevos;</p>

<p>4shared,
Mediafire,
Etrustdownloads,
Ziddu;</p>

<p>Akamaihd,
Amazonaws,
Blogspot,
Imageshack,
Issuu,
Mercadolibre,
Submanga,
Ytimg;</p>

<p>Avast,
Avgate,
Eset,
Mcafee,
Avira,
Bitdefender;</p>

<p>Windowsupdate,
Adobe;</p>

<p>Porntube,
Xvideos,<br>
Pornhub,
Redtube,
YouPorn,
Serviporno,
Tube8;</p>

<p>Appspot,
Cloudfront,
Juegosdiarios,
Juegosjuegos,
Netpocket,
Nordeus,
Popcap,
Socialpointgames,
Telaxo,
Tetrisfb,
Vostucdn,
Wooga,
Zgncdn;</p>

<p>Disneylatino,
Friv,
Geewa,
Hulkshare,
Kixeye,
Llnwd,
Maguinamotors,
Manabar;</p>

<p>SpeedTest (some servers);</p>
</li>
</ul>

<p>Configure your file /etc/haarp/haarp.lst to disable or enable the plugins.  </p>

<h2>
<a id="changelog" class="anchor" href="#changelog" aria-hidden="true"><span class="octicon octicon-link"></span></a>Changelog</h2>

<p><strong>Version 1.5.1</strong></p>

<p>2015/09/26</p>

<ul>
<li>Fix problem: "segfault at 10 ip 000000000042ee66 sp 00007fffb74d2270 error 4 in haarp[400000+45000]".</li>
<li>Manager of multiples ip in the header "X-forwarded-for".</li>
<li>Update bash script of installation: force the redirect to haarp from squid in squid.conf. </li>
</ul>

<p><strong>Version 1.5</strong></p>

<p>2015/09/14</p>

<ul>
<li>Storing the address IP of the user who uses the cache.</li>
<li>Adding user history for each file in cache.</li>
<li>Update the regexp for some plugins in haarp.lst.</li>
<li>By default, the 75% of the hard disk is used.</li>
</ul>

<p><strong>Version 1.4.1</strong>
<em>Thanks to Hernan Dario Nacimiento.</em></p>

<p>2015/07/31</p>

<ul>
<li>Update the plugins for edgecastcdn, socialpointgames and akamaihd.</li>
<li>Update plugin of Youtube: not cached of videos on live.</li>
<li>Using the parameter ‘clen’ of the url from youtube as file size.</li>
<li>Update the HaarpClean program.</li>
<li>Fixed the problem of bad replacement string in the SQL requests.</li>
<li>Update the file of configuration for logrotate.</li>
<li>Fix problem: ‘general protection ip:7f39b6cdd44e sp:7ffc278771f0 error:0 in libmysqlclient.so.18.0.0‘.</li>
</ul>

<p><strong>Version 1.4</strong></p>

<p>2015/07/07</p>

<ul>
<li>Adding 50 new plugins.</li>
<li>Improved support for DASH technology.</li>
<li>Update the file of configuration for logrotate.</li>
<li>Fix problem: 'segfault at 6 ip 00007f850c2cef36 sp 00007fff19f22d00 error 4 in libmysqlclient.so.18.1.0'.</li>
<li>Fix problem: 'Error in /usr/local/sbin/haarp: free(): invalid pointer: 0x00007fb5e166d618'.</li>
</ul>

<p><strong>Version 1.3</strong></p>

<p>2015/06/13</p>

<ul>
<li>Fix Problem with concurrent caching of files.</li>
<li>Update the plugin Youtube. </li>
</ul>

<p><strong>Version 1.2.1</strong>
<em>Thanks to Samuel Espinoza, Oscar Vaquero y Fernando Maniglia.</em></p>

<p>2015/05/29</p>

<ul>
<li>Fix concurrent caching of files.</li>
<li>Update haarpclean script.</li>
<li>Update some plugins: Youtube, Dailymotion, 4shared, Issuu, Avgate, Submanga, YourPorn, PornHub, Xvideos, PornTube, Tube8. </li>
<li>Files of youtube are cached with the watch ID from the URL.</li>
</ul>

<p><strong>Version 1.2</strong></p>

<p>2013/12/24</p>

<ul>
<li>Improved ad-blocking plugin for Youtube.</li>
<li>Update plugins: globo.com, youtube.com.</li>
<li>Differentiation of the header for the chrome browser.</li>
<li>Update of haarpclean script for the cleaning the cache.</li>
<li>Synchronous to the storage of the cache in an only file.</li>
</ul>

<p><strong>Version 1.1</strong></p>

<p>2013/02/09</p>

<ul>
<li>Cache dynamic and intelligent.</li>
<li>Update of plugins for the smart operation.</li>
<li>Multidisc.</li>
<li>Blocking advertising to Youtube.</li>
<li>Cache of videos in html5 for Youtube.</li>
</ul>

<p>Fork created by</p>

<p>Manolo Canales</p>

<p><a href="mailto:kei.haarpcache@gmail.com">kei.haarpcache@gmail.com</a></p>

<p><a href="http://perufw.wordpress.com">http://perufw.wordpress.com</a></p>

<p><br></p>

<div align="center">
<p></p>
<h6>
<a id="if-you-find-this-code-useful-or-wish-to-fund-further-developmentyou-can-use-paypal-to-donate-to-the-haarpcache-project" class="anchor" href="#if-you-find-this-code-useful-or-wish-to-fund-further-developmentyou-can-use-paypal-to-donate-to-the-haarpcache-project" aria-hidden="true"><span class="octicon octicon-link"></span></a>If you find this code useful, or wish to fund further development,
you can use PayPal to donate to the HaarpCache project:</h6>
<a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=QYCCSYYGW52QU"><img src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif"></a>
</div>
    

<p></p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/andyalonzo/haarpcache/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/andyalonzo/haarpcache/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/andyalonzo/haarpcache"></a> is maintained by <a href="https://github.com/andyalonzo">andyalonzo</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-63531854-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
